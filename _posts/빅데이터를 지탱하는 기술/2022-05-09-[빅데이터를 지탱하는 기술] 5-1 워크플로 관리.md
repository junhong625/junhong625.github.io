---
layout : post
title : '[빅데이터를 지탱하는 기술] 5-1 워크플로 관리'
subtitle : '[빅데이터를 지탱하는 기술] 정리'
gh-repo: junhong625/Study
gh-badge: [star, fork, follow]
tags : [빅데이터를 지탱하는 기술, Study]
comments: true
---

# 5-1 워크플로 관리
- - - 

## [기초 지식] 워크플로 관리 - 데이터의 흐름을 일원 관리하기
- `워크플로 관리(workflow management)` : 기업 내의 정형적인 업무 프로세스(신청, 승인, 보고 등)와 같이 정해진 업무를 원활하게 진행하기 위한 구조
    - 정기적인 배치 처리의 실행에 유용해 데이터 처리 현장에서 자주 이용된다.
<br>
<br>

### 1) 워크플로 관리 도구
- `워크플로 관리 도구` : 데이터 파이프라인의 모든 태스크를 일원 관리하기 쉽게 한 것
- 워크플로 관리 도구의 주요 역할 : 
    - 정기적으로 태스크를 실행
    - 비정상적인 상태를 감지하여 그것에 대한 해결을 돕는 것
    - 데이터 파이프라인 전체가 원활하게 실행되도록 제어하는 것
- 기존에는 업무용으로 개발된 워크플로 관리 도구를 사용했으나 최근 데이터 파이프라인의 실행에 특화된 오픈 소스의 워크플로 관리 도구가 여럿 개발되었다.

|이름|종류|개발사|
|:--|:--|:--|
|Airflow(에어 플로우)|스크립트 형|Airbnb|
|Azkaban(아즈카반)|선언형|Linkedin|
|Digdag(디그더그)|선언형|트레주어 데이터|
|Luigi(루이지)|스크립트 형|Spotify|
|Oozie(우지)|선언형|The Apache Software Foundation|

<sub><b>[오픈 소스의 워크플로 관리 도구의 예]</b></sub>
<br>
<br>

### 2) 워크플로 관리 도구와 태스크
- `태스크(task)` : 데이터 파이프라인의 실행 과정에서 데이터를 잇달아 이동하면서 정해진 처리를 반복한다.
    - 태스크를 단지 실행하는 것만이라면 특별한 도구 필요 없이 자신이 직접 만든 스크립트를 실행시키는 것만으로도 데이터 파이프라인을 실현할 수 있다.
<img height=400 src="https://user-images.githubusercontent.com/83000975/168521608-e51f74d7-4739-4a59-9bb3-b8e26a5a908d.jpeg">
<sub><b>[워크플로 관리 도구에 의한 태스크의 실행]</b></sub>
<br>
<br>

### 3) 기본 기능과 빅데이터에서 요구되는 기능
- 워크플로 관리를 위해 전용 도구를 사용하는 이유 : 태스크 실행에 실패할 수 있기 때문이다.
- 워크플로가 제공하는 기능 :
    - 태스크를 정기적인 스케줄로 실행하고 그 결과 통지하기
    - 태스크 간의 의존 관계를 정하고 정해진 순서대로 빠짐없이 실행하기
    - 태스크의 실행 결과를 보관하고 오류 발생 시에는 재실행할 수 있도록 하기
    - Hadoop에서의 잡(job)을 손쉽게 호출하거나 집계 결과를 데이터 마트에 기록하는 기능
<br>
<br>

### 4) 선언 형과 스크립트 형 - 워크플로 관리 도구의 종류
- `선언형(declarative)` 도구 : XML이나 YAML 등의 서식으로 워크플로를 기술하는 타입
- 특징 : 
    - 미리 제공된 기능만 이용할 수 있다.
        - 범위 안이라면 최소한의 기술로 태스크를 정의할 수 있다.
    - 누가 작성해도 동일한 워크플로가 되기 때문에 유지 보수성이 높아진다.
    - 동일 쿼리를 파라미터만 바꾸어 여러 번 실행하거나 워크플로를 단순 반복적으로 자동 생성하는 경우에 사용된다.
- `스크립트 형(scripting)` 도구 : 스크립트 언어로 워크플로를 정의하는 유형
- 특징 :
    - **유연성**
    - 일반적인 스크립트와 동일하게 변수나 제어 구문을 사용할 수 있으므로 태스크이 정의를 프로그래밍할 수 있다.
    - 스크립트 언어에 의해 데이터 처리를 태스크 안에서 실행하는 것도 가능하다.
- ETL 프로세스에는 **스크립트 형**의 도구, SQL의 실행에는 **선언형** 도구 등으로 나누어 사용하는 것도 하나의 방법이다.
<br>
<br>

## 오류로부터의 복구 방법 먼저 생각하기
- 데이터 파이프라인을 매일 동작시키다 보면, 예기치 못한 오류가 분명 발생한다.
- 네트워크 및 하드웨어의 일시적인 장애, 구현상의 버그, 앞선에서 발생한 오류로 인한 장애 등 다양한 오류가 발생할 수 있다.
- 이 모든 것을 사전에 예상하는 것은 불가능하므로, 미리 예기치 못한 오류가 발생할 가능성을 고려하여 오류 발생 시의 배처 방법을 결정해두는 것이 중요하다.
- 워크플로 관리에서는 태스크의 실행 순서를 정하는 것과 동시에 오류로부터 어떻게 회복한 것인지에 대한 계획을 정한다.
- 오류가 발생해도 신속하게 회복할 수 있는 워크플로를 구축하여 매일 반복되는 데이터 처리를 안정적으로 실행할 수 있게 만들어야 한다.
<br>
<br>

### 1) 복구와 플로우의 재실행
- 오류 중에는 통신 오류와 같이 몇 차례 반복하면 성공하는 것과 인증 오류와 같이 반복해도 실패하는 것(수동 대처)이 있다.
- 기본적으로 워크플로 관리에서는 수작업에 의한 **복구**를 전제로 한 태스크를 설계한다.
    - 복구의 기초 : 플로우가 도중에 실패해도 나중에 동일 파라미터로 재실행이 가능하다.
- 실패한 태스크는 모두 기록하여 나중에 재실행할 수 있도록 한다.
- `플로우(flow)` : 워크플로 관리 도구에 의해 실행되는 일련의 태스크
    - 특징 :
        - 각 플로우에는 실행 시에 고정 파라미터가 부여되어 있다.
        - 일별 배치 처리하면 특정 날짜가 파라미터가 된다.
        - 실행했던 플로우와 그 파라미터를 자동으로 데이터베이스에 기록한다.
            - 실패한 플로우를 재실행하는 것만으로도 복구가 완료된다.
> [태스크를 되도록 작게 유지하기]
> - 빅데이터의 워크플로는 시간이 오래 걸리기 때문에 오류가 발생할 때마다 처음부터 재실행하는 것은 너무 많은 시간이 걸린다.
> - 큰 태스크는 나누어 적당히 작은 복수의 태스크로 플로우를 구성하자
> - 문제가 발생해도 도중에 재개할 수 있기 때문에 스케줄 지연을 최소한으로 억제할 수 있다.
<br>
<br>

### 2) 재시도 - 여러 차례 반복하는 오류는 자동화하고 싶다.
- 태스크 단위의 자동적인 재시도 : 여러 번 발생하는 오류에 대해서 자동화하여 수작업 없이 복구하고 싶을 때 1차적으로 시도 해볼 수 있는 해결책
    - 재시도하는 것은 간단하지만 재시도 횟수에는 주의가 필요하다.
    - 어느 정도의 재시도 횟수가 좋은지는 태스크의 성격에 따라 다르다.
    - 1~2회 정도의 재시도에도 해결되지 않는 태스크라면 다른 올바른 문제 해결방법을 찾는 것이 좋다.
<br>
<br>

### 3) 백필 - 일정 기간의 플로우를 연속해서 실행하는 구조
- `백필(backfill)` : 파라미터에 포함된 일시를 순서대로 바꿔가면서 일정 기간의 플로우를 연속해서 실행하는 구조
    - 태스크의 실패가 며칠 동안이나 계속된 후에 이를 모두 모아서 재실행하고 싶을 때나 새롭게 만든 워크플로를 과거로 거슬러 올라가 실행하고 싶은 경우에 사용한다.
- 백필 사용 시 주의할 점 :
    - 백필에 의해 대량의 태스크를 실행할 때에는 성능상의 주의가 필요하다.
        - 대량의 태스크를 실행하면 적은 양의 태스크를 실행할 때는 걸리지 않던 부하가 발생하며 평소라면 일어나지 않을 오류가 발생할 수 있다.
    - 자동적인 재시도는 모두 무효로 하고 오류는 모두 통지하는 편이 좋다.
    - 테스트 삼아 조금씩 백필을 실행하며 부하를 받지 않도록 적절히 조절해야 한다.
    - 오류가 난 태스크만을 재실행하면 모든 백필이 완료된다.
<br>
<br>

## 멱등한 조작으로 태스크를 기술하기 - 동일 태스크를 여러 번 실행해도 동일한 결과가 된다
- 각 태스크는 원칙적으로 **마지막까지 성공**하거나 **실패하면 아무것도 남지 않음** 이 둘 중 하나만 존재해야 한다.
- 동일한 태스크를 여러 번 실행해도 항상 동일한 결과가 나온다.  
    - 도중에 실패했을 때 경과가 사라지지 않으면 재실행시 데이터가 혼재하는 문제가 발생한다.
<br>
<br>

### 1) 원자성 조작
- `원자성(atomic)` : ACID 트랜잭션 특성 중의 하나로 간단하게 설명하자면 **트랜잭션의 일부만 수행한 상태로 종료할 수 없다.**라고 할 수 있다.
- `원자성 조작(atomic operation)` : 외부에서는 하나의 조작으로 보이는 조작의 집합을 말한다. 원자성 조작의 결과는 성공이나 실패 중의 하나이다.
    - 워크플로에 포함된 모든 태스크를 원자성 있는 조작으로 구현함으로써 재시도 시의 안정성을 높일 수 있다.
    - 원자성 조작인 경우에도 태스크 구현 상의 버그 등으로 문제를 일으킬 가능성이 있다. 
        - 그렇기 때문에 아주 작은 가능성도 허가하지 않을 때는 원자성 조작에 의존한 플로우를 만들어서는 안 된다.
        - 적어도 워크플로 관리 도구에 의한 자동적인 재시도는 피하고, 오류의 내용을 반드시 확인한 후에 수동으로 복구해야 한다.
<br>
<br>

### 2)멱등한 조작 - 추가와 치환
- `멱등한 조작` : 동일한 태스크를 여러 번 실행해도 동일한 결과가 나오도록 하는 것
- 일반적으로 워크플로의 각 태스크는 **추가(append)** 또는 **치환(replace)** 중 하나를 실시한다.
    - 두 가지 중 **치환**이 반복해도 결과가 변하지 않으므로 멱등하다고 할 수 있다.
    - 즉, 멱등한 태스크를 만들기 위해서는 고유의 이름을 생성하고 여러 번 실행해도 항상 치환이 실행되도록 설계해야 한다.
    - 그렇지 않을 경우 자동으로 복구하는 것이 어려운 플로우가 된다.
<br>
<br>

### 3) 멱등한 추가
- 항상 멱등한 조작으로 멱등한 태스크를 구현할 수는 없다.
- 그런 경우에 **테이블 파티셔닝**을 이용하여 파티션 단위로 치환하여 멱등성을 유지하면서 워크플로를 만드는 것이 가능하다.
    - 테이블 파티셔닝의 구현은 시스템에 따라 전혀 다르기 때문에 이용하는 시스템에 맞추어 플로우를 조립할 필요가 있다.
- 태스크를 멱등으로 구성하는 것이 어렵다면 포기하고 원자성을 지닌 추가만으로 운용한다.
    - 이 경우, 태스크를 재실행하면 데이터가 중복될 가능성이 있으므로 자동적인 재시도는 무효로 하고 오류 발생 시에는 수작업으로 복구해야 한다.
<br>
<br>

### 4) 원자성을 지닌 추가
- 복잡한 플로우에서 하나의 테이블에 여러번 데이터를 써넣을 때마다 데이터를 추가하는 것을 반복하는 것은 비효율적이고 안전하지 않다.
- 이 경우 중간 테이블을 만들어 처리한 후 마지막에 중간 테이블을 1회만 추가(원자성)하는 것이 안전하다.
    - 이렇게 해야 도중에 문제가 발생하더라도 어정쩡하게 데이터가 쓰이는 일이 없고 필요시에는 중간 데이터를 삭제하여 다시 재실행 할 수도 있다.
- 이렇게 구성을 해야 실패한 경우에는 아무것도 쓰이지 않아 실패한 태스크를 재실행하면 중복없이 복구가 완료된다.
<br>
<br>

## 워크플로 전체를 멱등으로 하기
- 데이터 파이프라인을 안정적으로 운용하기 위해서는 태스크나 플로우를 가능한 한 **멱등**으로 해야한다.
    - 데이터 수집 단계에서 테이블 파티셔닝을 도입함으로써 파티션 단위의 **치환**이 가능하게 만든다.
    - 벌크 형의 데이터 전송에 대해서 워크플로 관리 도구에서 날짜와 시간을 파라미터로 전달함으로써 **치환** 형의 태스크를 구축할 수 있다.
    - 데이터 마트를 구축하는 플로우에서도 되도록 추가는 삼가고 테이블마다 **치환**하도록 한다.
        - 이 과정에서 만들어진 중간 테이블도 가능한 한 **치환**하는 것이 바람직하지만 성능상의 이유 등으로 추가해야할 경우도 있다.
- 각 태스크를 멱등으로 하는 것이 이상적이지만 필수는 아니다.
    - 멱등이지 않아도 동작에 지장이 없다면 재시도 시 발생하는 중복의 가능성만 주의한다면 일반적인 운용으로 문제 될 일은 없다.
- 하지만 재실행의 안정성을 높이기 위해서는 각 플로우가 멱등하게 되도록 구현하는 것이 좋다.
<br>
<br>

## 태스크 큐 - 자원의 소비량 컨트롤하기
- `태스크 큐(tast queue)` : 워크플로 관리 도구에서의 부하를 컨트롤 하기 위해 태스크의 크기나 실행 태스크 수를 컨트롤 하는 역할
    - 모든 태스크를 큐에 저장되고 일정 수의 워커 프로세스가 순서대로 꺼내면서 병렬화가 실현되는 구조
- 주의해야할 점 : 
    - 병목 현상의 해소
        - 너무 많은 워커 작동으로 인한 병목 현상 발생하지 않도록 주의
    - 태스크 수의 적정화
        - Hadoop을 사용 시 적절하게 데이터를 분산하여 효율을 높이도록 하는 것과 마찬가지로 태스크의 크기를 적절하게 조정하고 병목 현상이 일어나지 않는 정도에서 워커의 수를 늘려두면 효율적으로 자원을 낭비하지 않고 활용할 수 있다.
