---
layout : post
title : '[빅데이터를 지탱하는 기술] 4-1 벌크 형과 스트리밍 형의 데이터 수집'
subtitle : '[빅데이터를 지탱하는 기술] 정리'
gh-repo: junhong625/Study
gh-badge: [star, fork, follow]
tags : [빅데이터를 지탱하는 기술, Study]
comments: true
---

# 4-1 벌크 형과 스트리밍 형의 데이터 수집
- - - 

## 객체 스토리지와 데이터 수집 - 분산 스토리지에 데이터 읽어들이기
- 빅데이터는 대부분의 경우 확장성이 높은 `분산 스토리지(distributed storage)`에 저장된다.
- 분산 형의 데이터베이스가 이용되는 경우도 있지만 기본적으로 대량의 파일을 저장하기 위한 `객체 스토리지(object storage)`를 이용한다.
    - 대표적인 `객체 스토리지`로 Hadoop의 **HDFS**와 클라우드 서비스 **Amazon S3**가 있다.
    - `객체 스토리지`는 네트워크를 거쳐 파일을 읽고 쓰는데 다수의 서버와 하드 디스크가 있어 일부 하드웨어가 고장나도 데이터가 손실되지 않는다.
    - 대량의 데이터에는 효율적이지만 소량의 데이터에는 비효율적이다.
<br>
<br>

### 데이터 수집
- 빅데이터에서 자주 다루는 시계열 데이터를 수시로 객체 스토리지에 기록하면 작은 파일의 개수가 점점 늘어나 시간이 지남에 따라 성능을 저하시키는 요인이 된다.
    - 작은 데이터는 적당히 모아서 하나의 파일로 만들어야 효율을 높일 수 있다.
- 반대로 파일이 지나치게 큰 경우, 네트워크 전송 시간이 오래 걸려 오류가 발생할 수 있다.
    - 거대한 데이터는 적당히 나눠 처리함으로써 문제 발생을 줄일 수 있다.
- 데이터 수집 시 나중에 처리하기 쉽도록 준비해둘 필요가 있다.
    - 객체 스토리지에서 효율적으로 처리할 수 있는 파일 크기 : 1MB~ 1GB
    - 파일 크기가 작은 경우 모아서 효율적인 크기로 만들고 큰 경우에는 나누는 것을 고려해야합니다.
-**데이터 수집(data ingestion)** : 수집한 데이터를 가공하여 집계 효율이 좋은 분산 스토리지를 만드는 일련의 프로세스
    - 데이터 수집 - 구조화 데이터의 작성 - 분산 스토리지에 대한 장기적인 저장
<img height=400 src="https://user-images.githubusercontent.com/83000975/167602922-fbd52a9e-a744-44fe-866b-55240fe0fa0f.jpeg">
<sub><b>[파일 사이즈를 적절한 크기로 유지하기]</b></sub>
<br>
<br>

## 벌크 형의 데이터 전송 - ETL 서버의 설치 필요성
- 전통적인 데이터 웨어하우스에서 사용되는 것은 **벌크 형**방식이다. 
- 과거에 데이터베이스에 축적시킨 데이터를 추출하고 싶은 경우에는 **벌크 형**의 데이터 전송을 한다.
- 데이터가 분산 스토리지에 저장되어 있는 것이 아니라면 `ETL 서버`를 설치한다.
    - `ETL 서버` : 구조화된 데이터 처리에 적합한 데이터 웨어하우스를 위한 ETL 도구와 오픈 소스의 벌크 전송 도구 또는 손수 작성한 스크립트 등을 이용하여 데이터를 전송한다.
<img height=400 src="https://user-images.githubusercontent.com/83000975/167605653-e7fc8ed0-f285-4150-bade-b6a104029215.jpeg">
<sub><b>[벌크 형의 데이터 전송]</b></sub>
<br>
<br>

### 1) 파일 사이즈의 적정화는 비교적 간단하다.
- 100개의 파일을 전송할 떄 100번 전송을 반복하는 것보다 모아서 하는 것이 더욱 좋다.
- 하지만 너무 많은 양의 데이터를 모아서 전송하면 디스크가 넘쳐 오류가 발생하거나 시간이 너무 오래 걸릴수도 있다.
- 워크플로 관리 도구를 사용하면 한 번의 태스크 실행이 커지지 않도록 조정할 수 있다.
    - 워크플로 관리 도구를 사용함으로써 디스크가 넘쳐나는 잠재적인 문제는 물론이고 다른 문제가 발생하더라도 재시도 하기가 쉬워진다.
<br>
<br>

### 2) 데이터 전송의 워크플로 - 워크플로 관리 도구와의 친화성
- **데이터 전송의 신뢰성**이 중요한 경우 가능한 한 **벌크 형** 도구를 사용해야 한다.
    - **스트리밍 형**과 다르게 데이터 전송을 재실행할 수 있다는 점이 벌크 형의 장점이다.
- **벌크 형**의 데이터 전송은 워크플로 관리 도구와의 궁합이 뛰어나다.
    - 과거의 데이터를 빠짐없이 가져오거나 실패한 작업을 재실행할 것을 고려한다면 벌크 형 전송을 해야 한다.
<br>
<br>

## 스트리밍 형의 데이터 전송 - 계속해서 전성되어 오는 작은 데이터를 취급하기 위한 데이터 전송
- 웹, 모바일, 디바이스 같이 다양한 통신장비 및 소프트웨어에서 생성되는 데이터는 스트리밍 형의 데이터 전송이 필요하다.
- 이러한 데이터 전송의 공통점은 `메시지 배송 방식`을 이용한다.
    - `메시지 배송 방식` : 다수의 클라이언트에서 계속해서 작은 데이터가 전송되는 것
    - 전송되는 데이터양에 비해 통신을 위한 오버헤드가 커지기 때문에 이를 처리하는 서버는 높은 성능을 요구한다.
<img height=400 src="https://user-images.githubusercontent.com/83000975/167610898-d1768600-9a7b-4c5b-aecd-e40419cd7f8d.jpeg">
<sub><b>[스트리밍 형의 메시지 배송]</b></sub>

- 이렇게 받은 메시지를 저장하는 데에는 몇 가지 방법이 있다.
    1. NoSQL 데이터베이스를 이용하여 저장하기.
        - Hive와 같은 쿼리 엔진으로 NoSQL 데이터베이스에 연결해 데이터를 읽을 수 있다.
    2. 분산 스토리지에 직접 쓰는 것이 아닌 **메시지 큐(message queue)**와 **메시지 브로커(message broker)** 등의 중계 시스템에 전송할 수 있다.
        - 이 경우 기록된 데이터는 일정한 간격으로 꺼내고 모아서 분산 스토리지에 저장한다.
<br>
<br>

### 1) 웹 브라우저에서의 메시지 배송 - Fluentd, Logstash, 웹 이벤트 트래킹
<img height=400 src="https://user-images.githubusercontent.com/83000975/167611748-575e6e0b-007f-4de2-af6d-0a70709155f1.jpeg">
<b><sub>[웹 브라우저로부터의 메시지 배송]</sub></b>

1. 자체 개발한 웹 애플리케이션 등에서는 그림 `웹 브라우저로부터의 메시지 배송`에서의 ❶처럼 웹 서버 안에서 메시지를 만들어 배송한다.
    - 전송 효율을 높이기 위해 서버 상주형 로그 수집 소프트웨어(**Flientd**, **Logstash**)를 사용하여 서버상에서 데이터를 축적해뒀다가 모아서 보내는 경우가 많다.
2. 다른 방법으로는 그림 `웹 브라우저로부터의 메시지 배송`에서의 ❷와 같이 `웹 이벤트 추적` 방법이 있다.
    - `웹 이벤트 추적(web event tracking)` : 자바스크립트를 사용하여 웹 브라우저에서 직접 메시지를 보내는 방법
    - HTML 페이지에 태그를 삽입만 하면 되므로 각종 액세스 분석 서비스 및 데이터 분석 서비스 등에서 사용되고 있다.
> [Fluentd에 의한 메시지 배송]
> - 메시지 브로커의 역할로 로그 수집 소프트웨어인 **Fluentd**를 사용하는 것을 고려할 수 있다.
> - 내부에 효율적인 버퍼링 메커니즘을 갖고 있어 일정한 시간 간격 또는 특정 사이즈에 맞춰 외부로 데이터를 모아서 내보낼 수 있다.
> - 단, 메시지 브로커로 설계된 것이 아니기 때문에 한계가 있다.
>   - 데이터를 복제할 수 없기 때문에, 노드가 고장 나서 버퍼가 사라진다면 보내지 못한 데이터는 없어진다.
>   - 메시지를 일방적으로 발송하는 것밖에 하지 못하므로 외부에서 요청해서 메시지를 꺼낼 수 없다.
>   - 배송에 성공한 메시지는 곧 사라져 버리기 때문에 나중에 다시 송신할 수 없다.
<br>
<br>

### 2) 모바일 앱으로부터의 메시지 배송
<img height=400 src="https://user-images.githubusercontent.com/83000975/167614583-ec7e1eba-7b8b-4f40-acbc-bc0a89d7f332.jpeg">
<sub><b>[모바일 앱으로부터의 메시지 배송]</b></sub>

- 모바일 앱의 통신 방법만을 보면 HTTP 프로토콜을 사용하므로 메시지 배송 방식이 웹 브라우저와 동일하다.
1. 서버를 직접 마련하는 것이 아니라 **MBaaS(Mobile Backend as a Service)**라는 백 엔드의 각종 서비스를 이용할 수도 있다.
    - 그림 `모바일 앱으로부터의 메시지 배송`의 ❶처럼 백 엔드 데이터 저장소에 저장한 데이터를 벌크 형 도구를 사용해서 꺼낼 수 있다.
2. 그림의 ❷와 같이 모바일 앱에 특화된 액세스 해석 서비스를 통해 이벤트 데이터를 수집한다.
    - 모바일 용의 편리한 개발 키트(SDK)를 사용하여 메시지를 보낸다.
    - 모바일 앱이 오프라인이 되는 경우 있으니 발생한 이벤트를 일단 SDK의 내부에 축적시키고 온라인 상태가 되었을 때 모아서 보내도록 만들어져 있다.
- 모바일 회선은 통신이 불안정하고 통신 오류에 따른 메시지 재전송이 여러 번 발생한다.
    - 데이터가 중복될 가능성도 높아 특정한 중복 제거(후술)의 구조가 필요하다. 
    - SDK를 도입할 경우에는 데이터의 중복에 대해 어떤 대책이 이루어지고 있는지 확인하는 것이 좋다.
<br>
<br>

### 3) 디바이스로부터의 메시지 배송 - MQTT의 예
- `MQTT(MQ Telemetry Transport)` : TCP/IP를 사용하여 데이터를 전송하는 프로토콜로 일반적으로 `Pub/Sub 형 메시지 배송`이라는 구조를 가진다.
    - `Pub/Sub 형 메시지 배송` : Pub/Sub는 **전달(Publish)**과 **구독(subscription)**의 약자이며 채팅, 메시징 앱, 푸시 알림 등의 시스템에서 자주 사용되는 기술이다.
    - MQTT에서는 관리자에 의해 `토픽(Topic)`이 만들어진다.
        - `토픽(Topic)` : 메시지를 송수신 하기 위한 대화방의 역할
    - 토픽을 구독하면 메시지가 도착 - 토픽을 전달 - 구독 중인 모든 클라이언트에게 전송
    - 이러한 메시지의 교환을 중계하는 서버를 `MQTT 브로커(MQTT broker)`라고 하고 메시지를 수신하는 시스템을 `MQTT 구독자(MQTT subscriber)`라고 한다.
    - MQTT는 HTTP와 다르게 네트워크에서 분리된 경우에도 나중에 재전송하는 구조가 프로토콜 수준에서 구현되어 있다.
    <img height=400 src="https://user-images.githubusercontent.com/83000975/167617063-0b1ffcea-a969-48fd-88f9-c8bb90e94ec7.jpeg">
    <b><sub>[디바이스로부터의 메시지 배송]</sub></b>
    <br>
    <br>

### 4) 메시지 배송의 공통화 - 다른 부분과 공통되는 부분을 분리해서 생각하기
- 메시지 배송 방식은 환경에 따라 다른 부분과 공통되는 부분을 분리하여 생각해야 한다.
- 각자의 역할을 분리하여 각자의 역할에 전념할 수 있도록 한다.
    - 프런트 엔드(메시지를 먼저 받는 서버를 지칭)가 받은 메시지는 그대로 메시지 브로커로 전송한다. 
    - 분산 스토리지에 데이터를 저장하는 것이 그 이후의 역할이다.
    - 이렇게 역할을 분리함으로써 프런트 엔드는 데이터를 받는 것에만 전념하고 그 이후의 문제에 대해서는 백 엔드에 존재하는 공통 시스템에 맡길 수 있다.
