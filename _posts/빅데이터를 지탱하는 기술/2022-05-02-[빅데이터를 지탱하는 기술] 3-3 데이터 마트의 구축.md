---
layout : post
title : '[빅데이터를 지탱하는 기술] 3-3 데이터 마트의 구축'
subtitle : '[빅데이터를 지탱하는 기술] 정리'
gh-repo: junhong625/Study
gh-badge: [star, fork, follow]
tags : [빅데이터를 지탱하는 기술, Study]
comments: true
---

# 3-3 데이터 마트의 구축
- - - 

## 팩트 테이블 - 시계열 데이터 축적하기
- 팩트 테이블의 작성 방법 : 
    1. 추가(append) : 새로 도착한 데이터만을 증분으로 추가
    2. 치환(replace) : 과거의 데이터를 포함하여 테이블 전체를 치환

<img height=400 src="https://user-images.githubusercontent.com/83000975/167360349-d42395e4-f98a-434a-9b38-8339b0a39862.jpeg">
<sub><b>[팩트 테이블의 추가와 치환]</b></sub>
<br>
<br>

### 1) 테이블 파티셔닝
- 효율만 따졌을 때 : **추가 > 치환**
    - 하지만 추가에는 3가지 잠재적 문제가 있음 : 
        1. 추가에 실패한 것을 알아채지 못하면 팩트 테이블의 일부에 결손이 발생
        2. 추가를 잘못해서 여러 번 실행하면 팩트 테이블의 일부가 중복
        3. 나중에 팩트 테이블을 다시 만들고 싶은 경우의 관리가 복잡해짐
    - 이와 같은 문제가 일어날 가능성을 줄이기 위해 `테이블 파티셔닝` 기술을 사용
- `테이블 파티셔닝(table partitioning)` : 하나의 테이블을 여러 물리적인 파티션으로 나눔으로써 파티션 단위로 정리하여 데이터를 쓰거나 삭제할 수 있도록 한 것
    - 정해진 패턴에 의해 새 파티션을 만들고 팩트 테이블이 붙여 놓음
    - 각 파티션은 매번 교체, 이미 존재한다면 덮어씀
    - 데이터가 중복될 가능성을 배제하면서 필요에 따라 여러 번 데이터의 기록을 바로 잡을 수 있음
<img height=400 src="https://user-images.githubusercontent.com/83000975/167361681-3c89bafa-3d47-4b4d-83c9-924c0b543727.jpeg">
<b><sub>[테이블 파티셔닝]</sub></b>
<br>
<br>

### 2) 데이터 마트의 치환
- 테이블 파티셔닝은 데이터 웨어하우스 구축에 유용
- 데이터 마트를 만드는 경우에는 팩트 테이블을 치환하는 경우가 많을 수도 있음
    - 팩트 테이블 전체를 치환하는 것의 장점 : 
        1. 중간 데이터가 중복되거나 빠뜨릴 가능성이 거의 없음
        2. 테이블을 처음부터 다시 만들고 싶다면 쿼리를 한 번 실행하기만 하면 됨
        3. 스키마 변경 등에 유연하게 대응 가능
        4. 오래된 데이터는 자동으로 지워지기 때문에 데이터 마트가 계속 확대되는 일이 없음
    - 유일하게 우려되는 점 : 처리시간
        - 데이터의 양이 너무 많아 처리 시간이 오래 걸릴 수도 있음(MPP 데이터베이스라면 병렬화하여 어느정도 속도를 높일 수 있음)
        - 그래도 시간이 너무 소요되는 경우에는 데이터 마트 측에서도 테이블 파티셔닝을 실시하거나 기존의 테이블에 추가한 다음 모니터링해야 함
- 하나의 데이터 처리에 걸리는 시간의 기준 : 각 데이터 처리가 1시간 이내에 완료하도록 워크플로를 짜는 것
    - 1시간 이내에 처리가 어려운 경우에만 치환이 아닌 추가를 이용한 워크플로를 고려해야 함
<br>
<br>

## 집계 테이블 - 레코드 수 줄이기
- **집계 테이블(summary table)** : 팩트 테이블을 모아서 집계하여 데이터의 양이 크게 줄어든 테이블
    - 집계 테이블을 만들기 위해서는 필요한 칼럼을 골라 숫자 데이터를 집계하면 됨
- **일일 집계(daily summary)** : 일일 보고서를 만드는 과정에서 자주 사용됨
    - 일일 집계를 잘 만들면 원래의 데이터가 아무리 대량으로 있어도 데이터 마트는 그다지 커지지 않음
<img height=400 src="https://user-images.githubusercontent.com/83000975/167364210-91880e49-63a5-48d8-bf5d-4c602d704d12.jpeg">
<sub><b>[집계 테이블의 예]</b></sub>

- **카디널리티(cardinality)** : 각 칼럼이 취하는 값의 범위 
    - ex) '성별'과 같이 취할 수 있는 값이 적은 것은 카디널리티가 작고, 'ip 주소'와 같이 여러 값이 있는 것은 카디널리티가 크다고 이야기 함
- 집계 테이블을 작게 하기 위해서는 모든 칼럼의 카디널리티를 줄여야 함
    - 카디널리티를 무리하게 낮추면 원래 있던 정보가 크게 손실되므로 필요 이상 줄일 필요 없음

> [집계 테이블에서의 숫자 계산에 주의하자]
> - 집계 테이블의 작성은 다차원 모델에서 디멘전을 줄이는 것과 같은 효과가 있음
> - 디멘전이 줄어들면 그만큼 분석할 수 있는 내용은 줄어들지만 측정값으로 계산된 결과에는 변함이 없음
> - 가급적 처음에 디멘전을 제거함으로써 데이터 마트가 작아지고 시각화 기능의 향상을 기대할 수 있음
> - 단 모든 측정값이 동일하게 계산되는 것이 아니므로 주의가 필요함
>   - ex) 평균값은 집계 테이블을 사용하면 제대로 계산할 수 없음
>       - 집계 테이블에서 올바른 평균을 내기 위해서는 합계(sum)와 개수(count)를 각각 측정값에 포함한 후에 BI 도구 등 동적으로 평균값을 계산해야 함 
> - 고유 수의 카운트도 집계 테이블에서는 취급하기 어려운 숫자
<br>
<br>

## 스냅샷 테이블 - 마스터의 상태를 기록하기
- 마스터 데이터처럼 업데이트될 가능성이 있는 테이블에 대한 두 가지 방안 : 
    1. **스냅샷 테이블(snapshot table)** : 정기적으로 테이블을 통쨰로 저장하는 방법
    2. **이력 테이블(history table)** : 변경 내용만을 저장하는 방법
- 데이터 분석을 생각하면 **스냅샷 테이블** 쪽이 취급하기 쉬움
- 스냅샷 테이블의 특징 : 
    1. 시간이 지남에 따라 점점 커지므로 이것도 일종의 **팩트 테이블**로 간주함
    2. 다른 팩트 테이블과 결합하여 **디멘전 테이블**로도 사용 가능
    3. **팩트 테이블**과 날짜를 포함해서 결합할 수도 있음
        - 매일 변화하는 마스터 정보를 이용하여 데이터를 분석하고 싶을 때 유용
    4. 특정 시점의 테이블의 상태를 기록한 것이므로 나중에 다시 만들 수 없음
        - 데이터 레이크나 데이터 웨어하우스와 같은 영구적인 저장소에 보관하여 삭제되지 않도록 함

> [스냅샷 날짜에 주의]
> - ex) 심야 0시에 스냅샷을 취득 즉, 하루의 시작 상태를 기록하도록 함
>   - 이 스냅샷을 트랜잭션 데이터와 결합하면 그림`[스냅샷과 트랜잭션 날짜 일치시키기]`처럼 됨
>   - 트랜잭션 데이터의 집계에서는 대부분의 경우 시간 부분을 잘라버림
>       - ex) 1월 1일부터 1월 2일까지 발생한 이벤트라면 1월 1일의 집계한 결과가 됨.
>       - 그러나 0시 시점의 스냅샷에는 그날에 발생한 이벤트의 마스터 데이터가 아직 포함되어 있지 않음
>       - 이 시간의 차이를 고려하지 않은 채 테이블을 조인하면 '가입 당일의 사용자 정보를 얻을 수 없다'는 문제가 발생함
>   - **문제 해결 방법 : 스냅샷을 하루의 시작이 아닌 하루의 끝에 취득하는 것**
<br>

> [스냅샷 시에 비정규화하기]
> - 정규화된 데이터베이스에서 마스터 정보가 다수의 테이블로 구성되는 일이 드물지 않음
> - 그 테이블을 하나하나 스냅샷 하는 것이 아니라 미리 모든 테이블을 결합하여 비정규화한 상태에서 스냅샷 해도 상관 없음
>   - 데이터를 분석할 때는 결국 모든 테이블을 결합하는 것이기 때문에 처음부터 비정규화 된것이 편함
<br>
<br>

## 이력 테이블 - 마스터 변화 기록하기
- **이력 테이블(history table)** : 변경된 데이터만을 증분으로 스냅샷 하거나 변경이 있을 때마다 그 내용을 기록하는 방법
    - 데이터 양을 줄이는데 도움은 되지만 완전한 마스터 테이블을 나중에 복원하는 것이 어려워지므로 디멘전 테이블로 사용하기 어려움
    - 이를 해결하기 위해서는 과거로 거슬러 올라가 재구축해야하는데 이런 복잡한 처리를 나중에 실행할 정도라면 차라리 처음부터 완전한 스냅샷을 만들어 두는 편이 좋음
    - **그래서 마스터 관계의 테이블은 기본적으로 매일 스냅샷 해야 한다고 생각해야 함!!**
<br>
<br>

## [마지막 단계] 디멘전을 추가하여 비정규화 테이블 완성시키기
- 팩트 테이블과 디멘전 테이블을 결합하여 비정규화 테이블을 만듦
- 디멘전 테이블로는 스냅샷을 사용할 뿐만 아니라 목적에 따라 각종 중간 테이블이 만들어짐
<br>
<br>

### 데이터 집계의 기본형
1. 팩트 테이블에서 필요한 데이터를 꺼냄
    - 시간에 의한 검색이나 참고하는 칼럼 수를 줄임으로써 데이터의 로드 속도는 빨라짐
2. 꺼낸 데이터를 디멘전 테이블과 결합하여 데이터 마트에 저장할 칼럼을 선택
    - 가급적 카디널리티를 작게 하는 것이 중요함
3. 그룹화하여 측정값을 집계
- 이와 같이 3단계의 순서로 진행하면 충분히 작은 비정규화 테이블이 만들어짐
- 이후 그 결과를 데이터 마트로 내보내거나 CSV파일로 저장하면 완료됨
