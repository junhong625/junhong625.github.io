---
layout : post
title : '[빅데이터를 지탱하는 기술] 4-3 시계열 데이터 최적화'
subtitle : '[빅데이터를 지탱하는 기술] 정리'
gh-repo: junhong625/Study
gh-badge: [star, fork, follow]
tags : [빅데이터를 지탱하는 기술, Study]
comments: true
---

# 4-3 시계열 데이터 최적화
- - - 

## 프로세스 시간과 이벤트 시간 - 데이터 분석의 대상은 주로 이벤트 시간
- 스마트 폰에서 데이터 수집 시 전파가 닿지 않는 곳에 있거나 배터리 방전으로 인해 메시지가 며칠 뒤에 도착하는 경우가 있다.
- 따라서 그러한 지연 상황까지 예측해서 데이터 분석을 고려해야 한다.
- `이벤트 시간`이 데이터 분석의 대상이 되는데 `이벤트 시간`과 `프로세스 시간`의 차이가 성가신 문제를 일으킨다.
    - `이벤트 시간(event time)` : 클라이언트 상에서 메시지가 생성되는 시간
    - `프로세스 시간(process time)` : 서버가 처리하는 시간
<br>
<br>

## 프로세스 시간에 의한 분할과 문제점 - 최대한 피하고 싶은 풀 스캔
- 모바일 앱의 활동 사용자 수를 집계한다면 늦게 도달하는 데이터가 있다는 것을 고려해 `이벤트 시간`보다 며칠 정도 지난 시점에 집계해야 실태에 가까운 집계 결과를 얻을 수 있다.
<img height=400 src="https://user-images.githubusercontent.com/83000975/168045213-e2da300d-8e89-4add-b1e8-a363ab761380.jpeg">
<b><sub>[이벤트 시간과 프로세스 시간에는 차이가 있다]</sub></b>

- 분산 스토리지에 데이터를 넣을 때는 보통 **프로세스 시간**을 이용한다.
- 여기서 중요한 점은 이벤트 시간과 프로세스 시간의 차이로 인해 특정 날짜의 데이터를 구하기 위해서는 `풀 스캔`을 해야 한다.
    - `풀 스캔(full scan)` : 다수의 파일을 모두 검색하는 쿼리
- 그런데 `풀 스캔`은 시스템의 부하를 크게 높이는 요인이 된다. 
    - 데이터가 `이벤트 시간`으로 정렬됐다면 원하는 날짜의 데이터를 쉽게 구할 수 있지만 `프로세스 시간`으로 정렬되어 있어 모든 데이터를 로드하는 한정된 자원을 낭비하는 작업을 반복해야 한다.
- 피하고 싶은 부분이지만 원하는 데이터를 얻어내기 위해서는 감내해야 한다.
<br>
<br>

- 이벤트 시간 취급을 효율화하기 위해 데이터를 정렬하는 것에는 여러가지 방법이 있다.

## 시계열 인덱스 - 이벤트 시간에 의한 집계의 효율화 ①
- 예를 들어, **Cassandra**같은 **시계열 인덱스**에 대응하는 분산 데이터베이스를 이용하면 처음부터 이벤트 시간으로 인덱스를 설정해 테이블을 만들 수 있다.
- 시계열 인덱스를 사용하면 매우 짧은 범위의 특정 시간에 맞춘 데이터 집계를 빠르게 실행할 수 있다.
    - 정해진 시간에 발생한 이벤트를 조사하거나, 실시간 대시보드를 만드는 경우에 유용하다.
- 한편 장기간에 걸쳐서 대량의 데이터를 집계하는 경우에는 분산 데이터베이스보다 열 지향 스토리지를 사용하는 것이 더욱 집계 효율이 뛰어나다.
<br>
<br>

## 조건절 푸쉬다운 - 이벤트 시간에 의한 집계의 효율 ②
- 열 지향 스토리지에서는 RDB와 동등한 인덱스를 만들 수 없지만 처음에 데이터를 정렬할 수 있다.
- 이를 이용하여 데이터를 이벤트 시간을 기준으로 정렬한 후에 열 지향 스토리지로 변환한다.
- 열 지향 스토리지는 **칼럼 단위의 통계 정보**를 이용하여 최적화가 이루어진다.
- 예를 들어 시간이면 **각 칼럼의 최솟값과 최댓값 등이 파일의 메타정보에 저장**되어 있어 어떤 파일의 어떤 부분에 원하는 데이터가 포함되어 있는지 알 수 있다.
    - 이를 이용하여 최소한의 데이터만을 읽도록 하는 최적화를 `조건절 푸시 다운(predicate pushdown)`이라고 한다. 
- `조건절 푸시 다운`이 이루어지도록 열 지향 스토리지를 최적화 해두면 풀 스캔을 피할 수 있다는 장점이 있다.

> [빈번한 쓰기는 최적화의 효과를 낮춘다]
> - `조건절 푸시다운`을 최대한 활용하려면 집계 시의 데이터 로딩이 최소한으로 끝날 수 있도록 다수의 데이터를 한 곳에 배치해야 한다.
> - 즉, 데이터를 정렬해 데이터가 충분히 연속적으로 배치되어야 최적화 효과가 높아진다.
> - 그리고 열 지향 스토리지를 만들 때 짧은 주기로 만들면 정렬하더라도 다수의 파일로 데이터가 분산되기에 정렬하더라도 효과가 떨어진다.
<br>
<br>

## 이벤트 시간에 의한 분할 - 테이블 파티셔닝, 시계열 테이블
- 이벤트 시간에 의한 집계를 효율화 시켰더라도 동일 이벤트 시간의 데이터는 다수의 파일에 분산되어 있다.
- 이를 해결하기 위해 테이블 파티셔닝을 이용하여 `시계열 테이블`을 만들고 동일한 이벤트 시간 데이터들끼리 모이도록 한다.
- 장점 : 이벤트 시간에 의한 데이터 검색을 더욱 효율적으로 할 수 있게된다.
- 단점 : 분산 스토리지에 대량의 작은 파일이 만들어져 점차 쿼리의 성능이 악화된다.
    - 이를 해결하기 위해 작은 데이터를 효율적으로 추가할 수 있는 분산 데이터베이스를 사용하거나 아주 오래된 데이터를 버리는 아이디어가 필요하다.
<br>
<br>

### 데이터 마트를 이벤트 시간으로 정렬하기
- 위 방법보다 더 좋은 방법은 데이터 마트에서만 이벤트 시간에 의한 정렬을 하도록 해두는 것이다.
- 데이터 수집 단계에서는 이벤트 시간을 따지지 않고 프로세스 시간을 사용하여 데이터를 저장한다.
- 그리고 데이터 마트를 만드는 단게에서 이벤트 시간에 의한 정렬을 하도록 한다.
- 이렇게 하면 파일이 조각나거나 쿼리의 성능이 악화되는 일 없이 최적의 데이터 마트를 유지할 수 있다.
<img height=400 src="https://user-images.githubusercontent.com/83000975/168054644-c30c7487-7d56-42d2-b906-6fffdc23b663.jpeg">
<b><sub>[데이터 마트를 이벤트 시간으로 정렬하여 생성]</sub></b>
